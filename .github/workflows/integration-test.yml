name: Integration Test
on:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

jobs:
  integration-test:
    runs-on: ubuntu-latest
    # Only run if a valid FlyFrog test URL is configured
    if: vars.FLYFROG_TEST_URL != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate FlyFrog server endpoints
        run: |
          FLYFROG_URL="${{ vars.FLYFROG_TEST_URL || 'https://flyfrog.example.com' }}"
          echo "Testing FlyFrog server at: $FLYFROG_URL"
          
          # Test if the server responds (basic connectivity check)
          if ! curl -s --max-time 10 "$FLYFROG_URL" > /dev/null; then
            echo "⚠️  Warning: FlyFrog server is not reachable"
            echo "Integration test may fail due to server connectivity"
          else
            echo "✅ FlyFrog server is reachable"
          fi

      - name: Run FlyFrog action
        id: run-action
        uses: ./
        with:
          url: ${{ vars.FLYFROG_TEST_URL || 'https://flyfrog.example.com' }}
          ignore: docker, podman

      - name: Assert action completed successfully
        run: |
          echo "✅ FlyFrog action completed without errors"
          echo "   - OIDC authentication succeeded"
          echo "   - Package managers configured successfully"
          echo "   - CI end notification completed"
