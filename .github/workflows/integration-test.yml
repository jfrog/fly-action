name: Integration Test
on:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run FlyFrog action
        id: run-action
        uses: ./
        with:
          url: 'https://ffjob1682705.jfrogdev.org'
          ignore: docker, podman, helm

      - name: Test Artifactory OIDC access with curl
        shell: bash
        run: |
          echo "Attempting to curl Artifactory setuptools endpoint with OIDC credentials..."
          TARGET_URL="https://ffjob1682705.jfrogdev.org/artifactory/api/pypi/pip/simple/setuptools/"
          OIDC_TOKEN="${{ steps.run-action.outputs.oidcToken }}"

          echo "Target URL: $TARGET_URL"
          if [ -n "$OIDC_TOKEN" ]; then
            echo "OIDC Token (first 5 chars): ${OIDC_TOKEN:0:5}..."
          else
            echo "OIDC Token is empty."
          fi
          
          curl -I -f -H "Authorization: Bearer $OIDC_TOKEN" "$TARGET_URL"

      - name: Verify pip configuration
        shell: bash
        run: |
          set -e # Exit on error
          echo "Verifying pip target host configuration..."
          configured_url=$(pip config get global.index-url)
          expected_url_base="https://ffjob1682705.jfrogdev.org"

          # Extract hostname from expected_url_base (e.g., flyfrog.example.com)
          expected_host_part="${expected_url_base#*://}" # Remove scheme (e.g., flyfrog.example.com/somepath)
          expected_host="${expected_host_part%%/*}"      # Remove path (e.g., flyfrog.example.com)
          if [[ -z "$expected_host" ]]; then expected_host="$expected_host_part"; fi # Handle case where there is no path

          # Check if configured_url targets the expected_host, allowing for user:token@
          if [[ "$configured_url" == *"://"*@"${expected_host}"* || "$configured_url" == *"://${expected_host}"* ]]; then
            echo "Pip index-url appears to be configured for the correct host. Verification successful."
          else
            echo "Error: Pip index-url does not appear to be configured for the correct host (expected host: $expected_host)."
            exit 1
          fi

      - name: Print package managers info
        run: |
          pip cache purge
          pip install --force-reinstall setuptools --no-cache-dir